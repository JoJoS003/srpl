#!/usr/bin/env ruby
#encoding=utf-8

$LOAD_PATH.unshift(File.dirname(__FILE__) + "/../lib")

require 'srpl'
require 'yaml'
require 'erb'
require 'pp'

include SRPL

class SRPL_CLI
  
  
  attr_reader :league
  
  def initialize(plist = nil)
    @file = 'league.yml'
    from_players(plist.to_s) if plist
  end
  
  def load
    @league = @file ? YAML::load(File.read(@file)) : League.new
  end
  
  def save
    File.write(@file, YAML::dump(@league))
  end
  
  def rank
    template = %{
<h2>Classement</h2>
<table width="100%">
  <thead>
    <tr>
      <th><abbr style="border-bottom: 1px dashed black; cursor: help;" title="Classement">#</abbr></th>
      <th>Perso</th>
      <th>Joueur</th>
      <th><abbr style="border-bottom: 1px dashed black; cursor: help;" title="Matchs joués">J.</abbr></th>
      <th><abbr style="border-bottom: 1px dashed black; cursor: help;" title="Matchs gagnés">V.</abbr></th>
      <th><abbr style="border-bottom: 1px dashed black; cursor: help;" title="Matchs perdus">D.</abbr></th>
      <th><abbr style="border-bottom: 1px dashed black; cursor: help;" title="Matchs pour">P.</abbr></th>
      <th><abbr style="border-bottom: 1px dashed black; cursor: help;" title="Matchs contre">C.</abbr></th>
      <th><abbr style="border-bottom: 1px dashed black; cursor: help;" title="Score">S.</abbr></th>
      <th><abbr style="border-bottom: 1px dashed black; cursor: help;" title="Différence entre pour et contre">Diff.</abbr></th>
    </tr>
  </thead>
  <tbody>
    <% last_rank = 1 %>
    <% last_score = -1 %>
    <% players.each_index do |i| %>
      <% player = players[i] %>
      <% cur_rank = (player.score == last_score ? last_rank : i+1) %>
      <% last_rank = cur_rank %>
      <% last_score = player.score %>
      <tr>
        <td align="center"><%= cur_rank %></td>
        <td align="center"><img title="<%= player.character %>" alt="Image <%= player.character %>" src="<%= perso_img(player.character) %>" width="32px" /></td>
        <td><%= player.name %></td>
        <td align="center"><%= player.plays %></td>
        <td align="center"><%= player.wins %></td>
        <td align="center"><%= player.defeats %></td>
        <td align="center"><%= player.towards %></td>
        <td align="center"><%= player.againsts %></td>
        <td align="center"><%= player.score %></td>
        <td align="center"><%= player.goal_average %></td>
    </tr>
    <% end %>
  </tbody>
  <tfooter>
    <tr>
      <th><abbr style="border-bottom: 1px dashed black; cursor: help;" title="Classement">#</abbr></th>
      <th>Perso</th>
      <th>Joueur</th>
      <th><abbr style="border-bottom: 1px dashed black; cursor: help;" title="Matchs joués">J.</abbr></th>
      <th><abbr style="border-bottom: 1px dashed black; cursor: help;" title="Matchs gagnés">V.</abbr></th>
      <th><abbr style="border-bottom: 1px dashed black; cursor: help;" title="Matchs perdus">D.</abbr></th>
      <th><abbr style="border-bottom: 1px dashed black; cursor: help;" title="Matchs pour">P.</abbr></th>
      <th><abbr style="border-bottom: 1px dashed black; cursor: help;" title="Matchs contre">C.</abbr></th>
      <th><abbr style="border-bottom: 1px dashed black; cursor: help;" title="Score">S.</abbr></th>
      <th><abbr style="border-bottom: 1px dashed black; cursor: help;" title="Différence entre pour et contre">Diff.</abbr></th>
    </tr>
  </tfooter>
</table>
}
    players = @league.rank
    ERB.new(template).result(binding)
  end
  
  def characters
    template = <<-EOF
<h2>Persos</h2>
<ul>
  <% persos.each do |perso, count| %>
  <li style="display: inline-block; text-align: center; margin: 5px;">
    <img style="display: block;" title="<%= perso %>" alt="Image <%= perso %>" src="<%= perso_img(perso) %>" width="32px" />x <%= count %>
  </li>
  <% end %>
</ul>
    EOF
    
    persos = {}
    @league.players.each do |p|
      persos[p.character] = persos[p.character] ? persos[p.character] + 1 : 1
    end
    persos = persos.sort_by {|perso, nbr| nbr}.reverse!
    
    ERB.new(template).result(binding)
  end
  
  private 
  
  def from_players(file)
    reg = /^(?<nick>[\w\s]+) <(?<email>[\w\d\-_.]+@[\w\d-_.]+\.[\w]{2,4})> : (?<chara>[\w\. \-]+)$/

    @league = League.new

    File.open(file, 'r') do |io|
      io.lines do |line|
        m = reg.match line
        @league.add_player(Player.new(m['nick'], m['chara'], m['email'])) if m
      end
    end
    
    @league
  end
  
  def perso_img(perso)
    "http://shoryupif.fr/wp-content/uploads/2012/07/sprite_#{perso.downcase}.png"
  end

end

cli = ARGV[0] == 'init' ? SRPL_CLI.new(ARGV[1]) : SRPL_CLI.new

case ARGV[0]
  when 'init' then cli.save
  when 'round' then p cli.load.round
  when 'rank' then 
    cli.load
    puts cli.rank
  when 'characters' then
    cli.load
    puts cli.characters
end
